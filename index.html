<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aliados - Queda de Engrenagem | War System T20</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ivory: { 900: '#1a1a1a', 800: '#2d2d2d', accent: '#e6b800', tech: '#4db6ac' }
                    },
                    fontFamily: { 'cinzel': ['Cinzel', 'serif'], 'mono': ['Roboto Mono', 'monospace'], 'sans': ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #0f172a; color: #e2e8f0; }
        .card-glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .npc-dead { filter: grayscale(100%) brightness(50%); border-color: #334155 !important; }
        .npc-dead h4, .npc-dead .passive-text { text-decoration: line-through; color: #64748b; }
        .npc-dead .buff-tag { background-color: #450a0a !important; color: #fca5a5 !important; text-decoration: line-through; border-color: #7f1d1d !important; }
        
        .squad-card { cursor: pointer; transition: all 0.2s; }
        .squad-card:hover { transform: translateY(-2px); border-color: #e6b800; }
        
        .modal-enter { animation: modalIn 0.3s ease-out forwards; }
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }

        .sync-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="font-sans antialiased min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center flex-wrap gap-3">
            <div class="flex items-center gap-3">
                <button id="btn-back" onclick="showDashboard()" class="hidden text-ivory-accent hover:text-white transition">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                </button>
                <div>
                    <h1 class="font-cinzel text-xl text-ivory-accent font-bold tracking-wider">
                        <i class="fa-solid fa-shield-halved mr-2"></i>FOR√áAS DA RESIST√äNCIA
                    </h1>
                    <p class="text-slate-400 text-xs font-mono uppercase">Sistema de Batalha - Ano 3425</p>
                </div>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <div class="flex gap-1 bg-slate-800 p-1 rounded-lg border border-slate-700">
                    <button onclick="setTension(1)" id="btn-nt-1" class="px-3 py-1 rounded text-xs font-bold transition-colors">NT 1</button>
                    <button onclick="setTension(2)" id="btn-nt-2" class="px-3 py-1 rounded text-xs font-bold transition-colors">NT 2</button>
                    <button onclick="setTension(3)" id="btn-nt-3" class="px-3 py-1 rounded text-xs font-bold transition-colors">NT 3</button>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="exportData()" class="px-3 py-1.5 rounded text-xs font-bold bg-green-600 hover:bg-green-700 text-white transition-colors flex items-center gap-2" title="Exportar dados para compartilhar">
                        <i class="fa-solid fa-download"></i>
                        Exportar
                    </button>
                    <button onclick="importData()" class="px-3 py-1.5 rounded text-xs font-bold bg-purple-600 hover:bg-purple-700 text-white transition-colors flex items-center gap-2" title="Importar dados compartilhados">
                        <i class="fa-solid fa-upload"></i>
                        Importar
                    </button>
                    <button onclick="toggleAutoSync()" id="btn-sync" class="px-3 py-1.5 rounded text-xs font-bold bg-blue-600 hover:bg-blue-700 text-white transition-colors flex items-center gap-2" title="Sincroniza√ß√£o autom√°tica na nuvem">
                        <i class="fa-solid fa-cloud-arrow-up"></i>
                        <span id="sync-status">Auto Sync</span>
                    </button>
                    <div id="sync-indicator" class="hidden w-2 h-2 rounded-full bg-green-500 sync-indicator"></div>
                    <button onclick="showSyncModal()" class="px-2 py-1.5 rounded text-xs font-bold bg-slate-700 hover:bg-slate-600 text-white transition-colors" title="Configurar sincroniza√ß√£o">
                        <i class="fa-solid fa-gear"></i>
                    </button>
                    <button onclick="showGitHubTokenModal()" class="px-2 py-1.5 rounded text-xs font-bold bg-green-700 hover:bg-green-600 text-white transition-colors" title="Configurar Token do GitHub">
                        <i class="fa-brands fa-github"></i>
                    </button>
                    <button id="btn-copy-url" onclick="copyCurrentUrl()" class="px-3 py-1.5 rounded text-xs font-bold bg-amber-600 hover:bg-amber-700 text-white transition-colors flex items-center gap-2" title="Copiar URL atual">
                        <i class="fa-solid fa-link"></i>
                        Copiar URL
                    </button>
                </div>
            </div>
        </div>
        <div id="tension-display" class="bg-slate-800/80 border-b border-slate-700 px-4 py-2 text-center text-xs">
            <span id="tension-desc" class="text-slate-300"></span>
        </div>
    </header>

    <main class="flex-grow p-4 max-w-7xl mx-auto w-full relative">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">
            
            <!-- LEFT: SQUADS LIST -->
            <section class="lg:col-span-7 space-y-6">
                
                <!-- ALLIES -->
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-cinzel text-lg text-slate-200 flex items-center gap-2">
                            <i class="fa-solid fa-chess-rook text-ivory-tech"></i> Esquadr√µes Aliados
                            <span class="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-500 border border-slate-700">Her√≥is de 3425</span>
                        </h2>
                        <div class="text-xs text-slate-500 flex items-center gap-2">
                            <span id="last-sync-time"></span>
                            <span id="sync-status-text" class="hidden text-green-400">
                                <i class="fa-solid fa-circle-check"></i> Sincronizado
                            </span>
                            <span id="sync-error-text" class="hidden text-red-400">
                                <i class="fa-solid fa-triangle-exclamation"></i> Erro na sincroniza√ß√£o
                            </span>
                        </div>
                    </div>
                    <div id="squad-list-allies" class="space-y-3"></div>
                </div>

            </section>

            <!-- RIGHT: COMMAND & ACTIONS -->
            <section class="lg:col-span-5 space-y-6">
                
                <!-- TACTICAL ACTIONS -->
                <div class="card-glass rounded-xl p-4 border-t-4 border-blue-500">
                    <h2 class="font-cinzel text-lg text-slate-200 mb-3">
                        <i class="fa-solid fa-gavel mr-2 text-blue-400"></i>Ordens T√°ticas
                    </h2>
                    <div class="grid grid-cols-1 gap-2 mb-4">
                        <button onclick="selectAction('ATQ')" class="btn-action bg-slate-800 hover:bg-slate-700 border border-slate-600 p-3 rounded text-left group transition-all">
                            <div class="font-bold text-red-300 text-sm flex items-center gap-2">
                                <i class="fa-solid fa-crosshairs"></i>COORDENAR FOGO
                            </div>
                            <div class="text-[10px] text-slate-400 opacity-70 group-hover:opacity-100 mt-1">+2 Ataque. +4d6 Dano (Flanqueio).</div>
                        </button>
                        <button onclick="selectAction('DEF')" class="btn-action bg-slate-800 hover:bg-slate-700 border border-slate-600 p-3 rounded text-left group transition-all">
                            <div class="font-bold text-blue-300 text-sm flex items-center gap-2">
                                <i class="fa-solid fa-shield"></i>LINHA DE DEFESA
                            </div>
                            <div class="text-[10px] text-slate-400 opacity-70 group-hover:opacity-100 mt-1">+5 Defesa. Cobertura Total.</div>
                        </button>
                        <button onclick="selectAction('MOV')" class="btn-action bg-slate-800 hover:bg-slate-700 border border-slate-600 p-3 rounded text-left group transition-all">
                            <div class="font-bold text-amber-300 text-sm flex items-center gap-2">
                                <i class="fa-solid fa-person-running"></i>REPOSICIONAR
                            </div>
                            <div class="text-[10px] text-slate-400 opacity-70 group-hover:opacity-100 mt-1">Deslocamento Dobrado. Foge de Combate.</div>
                        </button>
                        <button onclick="selectAction('ESP')" class="btn-action bg-slate-800 hover:bg-slate-700 border border-slate-600 p-3 rounded text-left group transition-all">
                            <div class="font-bold text-purple-300 text-sm flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles"></i>RITUAL DE GUERRA
                            </div>
                            <div class="text-[10px] text-slate-400 opacity-70 group-hover:opacity-100 mt-1">Recupera 1 Baixa ou Buff em √Årea.</div>
                        </button>
                    </div>
                </div>

                <!-- STATUS SUMMARY -->
                <div class="card-glass rounded-xl p-4 border-t-4 border-green-500">
                    <h2 class="font-cinzel text-lg text-slate-200 mb-3">
                        <i class="fa-solid fa-chart-line mr-2 text-green-400"></i>Resumo T√°tico
                    </h2>
                    <div id="status-summary" class="space-y-2 text-sm">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </section>
        </div>

        <!-- SQUAD DETAIL VIEW -->
        <div id="view-squad-detail" class="hidden animate-fade-in pb-10">
            <div id="squad-detail-header" class="mb-6"></div>
            <div id="squad-detail-npcs" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- LORE MODAL -->
        <div id="lore-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="closeLoreModal()">
            <div class="bg-slate-900 border border-ivory-accent rounded-xl max-w-lg w-full p-6 relative shadow-2xl modal-enter max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <button onclick="closeLoreModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
                <div id="lore-content"></div>
            </div>
        </div>

        <!-- GITHUB TOKEN CONFIG MODAL -->
        <div id="github-token-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="closeGitHubTokenModal()">
            <div class="bg-slate-900 border border-green-500 rounded-xl max-w-lg w-full p-6 relative shadow-2xl modal-enter" onclick="event.stopPropagation()">
                <button onclick="closeGitHubTokenModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
                <h3 class="font-cinzel text-xl text-green-400 font-bold mb-4">üîë Configurar Token do GitHub</h3>
                <div class="space-y-4">
                    <div class="p-3 bg-blue-900/30 border border-blue-700/50 rounded text-xs text-blue-300">
                        <strong>üìù Como criar um token:</strong><br>
                        1. Acesse: <a href="https://github.com/settings/tokens" target="_blank" class="underline">github.com/settings/tokens</a><br>
                        2. Clique em "Generate new token (classic)"<br>
                        3. Permiss√£o: <strong>repo</strong> (Full control)<br>
                        4. Copie o token gerado e cole abaixo
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-2">Token do GitHub</label>
                        <input type="password" id="github-token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-green-500 font-mono" />
                        <p class="text-xs text-slate-500 mt-1">Seu token ser√° salvo localmente no navegador</p>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-2">Reposit√≥rio (opcional)</label>
                        <input type="text" id="github-repo-input" placeholder="joaolopeslenharo/sess-o-hoje" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-green-500" />
                        <p class="text-xs text-slate-500 mt-1">Deixe vazio para usar o padr√£o</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveGitHubToken()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold transition-colors">
                            <i class="fa-solid fa-save mr-2"></i> Salvar Token
                        </button>
                        <button onclick="closeGitHubTokenModal()" class="px-4 py-2 rounded text-sm font-bold transition-colors bg-slate-700 hover:bg-slate-600 text-white">
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYNC CONFIG MODAL -->
        <div id="sync-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-black/80 backdrop-blur-sm p-4" onclick="closeSyncModal()">
            <div class="bg-slate-900 border border-blue-500 rounded-xl max-w-lg w-full p-6 relative shadow-2xl modal-enter" onclick="event.stopPropagation()">
                <button onclick="closeSyncModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
                <h3 class="font-cinzel text-xl text-blue-400 font-bold mb-4">Configura√ß√£o de Sincroniza√ß√£o</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-slate-300 mb-2">ID da Sess√£o Compartilhada</label>
                        <input type="text" id="sync-session-id" placeholder="Ex: batalha-3425" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" />
                        <p class="text-xs text-slate-500 mt-1">Use o mesmo ID para sincronizar entre m√∫ltiplos jogadores</p>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-300 mb-2">URL do Endpoint P√∫blico (opcional)</label>
                        <input type="text" id="sync-endpoint" placeholder="Deixe vazio para usar servi√ßo padr√£o" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white text-sm focus:outline-none focus:border-blue-500" />
                        <p class="text-xs text-slate-500 mt-1">URL de um arquivo JSON p√∫blico ou endpoint de API</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveSyncConfig()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition-colors">
                            Salvar
                        </button>
                        <button onclick="generateShareLink()" class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-bold transition-colors">
                            Gerar Link
                        </button>
                        <button onclick="showHowToShare()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-bold transition-colors flex items-center justify-center gap-2">
                            <i class="fa-solid fa-question-circle"></i>
                            Como Compartilhar?
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- GitHub Sync Config (carregar antes do script principal) -->
    <script src="sync-config.js" onerror="console.warn('sync-config.js n√£o encontrado. Configure para usar GitHub API.')"></script>
    
    <script>
        // --- SYNC CONFIGURATION ---
        let syncEnabled = false;
        let syncInterval = null;
        let isSyncingFromCloud = false; // Flag para evitar loop de sincroniza√ß√£o quando recebendo dados do cloud
        
        // Carregar configura√ß√£o do GitHub (do arquivo ou localStorage)
        let githubConfig = window.GITHUB_CONFIG || null;
        
        // Se n√£o tiver config do arquivo, tentar carregar do localStorage
        if (!githubConfig || !githubConfig.token) {
            const savedToken = localStorage.getItem('github_token');
            const savedRepo = localStorage.getItem('github_repo') || 'joaolopeslenharo/sess-o-hoje';
            
            if (savedToken) {
                githubConfig = {
                    token: savedToken,
                    repo: savedRepo,
                    branch: 'main',
                    dataPath: 'data'
                };
                console.log('GitHub API configurado do localStorage');
            } else {
                console.log('GitHub API n√£o configurado. Configure o token na primeira vez.');
                // Mostrar modal de configura√ß√£o na primeira vez
                setTimeout(() => {
                    if (!localStorage.getItem('github_token_configured')) {
                        showGitHubTokenModal();
                    }
                }, 1000);
            }
        } else {
            console.log('GitHub API configurado do arquivo sync-config.js');
        }
        
        // Verificar se GitHub est√° configurado
        if (githubConfig && githubConfig.token && githubConfig.repo) {
            console.log('GitHub API configurado para:', githubConfig.repo);
        } else {
            console.log('GitHub API n√£o configurado. Usando localStorage.');
        }
        let syncSessionId = null;
        let syncEndpoint = null;
        let lastSyncHash = null;

        // Fun√ß√µes helper para codifica√ß√£o/decodifica√ß√£o Unicode-safe
        function encodeBase64(str) {
            try {
                return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
            } catch (e) {
                // Fallback: usar apenas encodeURIComponent
                return encodeURIComponent(str);
            }
        }

        function decodeBase64(str) {
            try {
                return decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) {
                // Fallback: tentar decodificar como URI
                try {
                    return decodeURIComponent(str);
                } catch (e2) {
                    return str;
                }
            }
        }

        // Fun√ß√£o para gerar hash simples de string
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16);
        }

        // --- DATA ---
        const defaultSquads = [
            {
                id: 1, isEnemy: false,
                name: "Resist√™ncia Central",
                role: "Prote√ß√£o & Controle",
                desc: "A linha t√™nue entre a sobreviv√™ncia e o esquecimento. N√£o lutam por gl√≥ria, mas para proteger o que restou de suas almas.",
                color: "text-green-400",
                baseStats: { atk: 18, def: 25, dmgDice: "1d8", dmgFlat: 8, init: 5 }, 
                damageType: "Biorrob√≥tica/Explosivo",
                npcs: [
                    { 
                        name: "Clarice Lins", role: "L√≠der Art√≠fice", dead: false, 
                        passive: "Biorrob√≥tica Arcana: O Esquadr√£o possui RD 10 (f√≠sico/m√°gico) devido aos escudos de campo gerados por Clarice.", 
                        buffs: { def: 4, atk: 0, dmg: 0, desc: "+4 DEF/RD 10 (Escudo de Campo)" },
                        lore: "Clarice √© uma mestra na manipula√ß√£o de metal e magia, mas nenhuma de suas inven√ß√µes foi capaz de impedir a trag√©dia que abateu sua fam√≠lia. Ap√≥s ser deixada por Cedric e ver seu filho Igor ser transformado em um Osteon, ela canalizou sua genialidade para um √∫nico prop√≥sito: a biorrob√≥tica arcana. Ela n√£o lidera por carisma maternal, mas por compet√™ncia t√©cnica."
                    },
                    { 
                        name: "Karn (Antigo Silas)", role: "Armadura Animada", dead: false, 
                        passive: "Reden√ß√£o de Ferro: Karn intercepta ataques letais. Uma vez por rodada, anula um acerto cr√≠tico contra o esquadr√£o.", 
                        buffs: { def: 4, atk: 0, dmg: 0, desc: "+4 DEF (Corpo Met√°lico)" },
                        lore: "Karn √© uma armadura animada que vaga com o peso de mem√≥rias que n√£o s√£o inteiramente suas. Ele carrega fragmentos da consci√™ncia de um soldado que falhou em proteger sua pr√≥pria fam√≠lia em uma guerra esquecida. Ao encontrar Clarice, ele viu nela a chance de reden√ß√£o que a morte lhe negou. Ele permite que Clarice conserte suas placas amassadas, n√£o para se manter forte, mas para garantir que ele possa ser o escudo que ela precisa."
                    },
                    { 
                        name: "Elian", role: "Demolidor", dead: false, 
                        passive: "Arte Explosiva: Ataques causam dano em √°rea (Reflexos CD 25 reduz metade). O caos √© sua forma de controle.", 
                        buffs: { def: 0, atk: 0, dmg: 5, desc: "+1d10 Dano (Bombas)" },
                        lore: "Elian ri quando as coisas explodem porque o sil√™ncio o aterroriza. Expulso de casa e rotulado como perigoso, ele encontrou na destrui√ß√£o uma forma de controle. Ele cria bombas complexas e belas como obras de arte, a √∫nica linguagem que ele conhece para expressar a raiva de ter sido descartado pelo mundo. Na Resist√™ncia, ele encontrou um lugar onde seu 'talento' √© √∫til, mas no fundo, ele espera que um dia algu√©m olhe atrav√©s da fuma√ßa e veja a crian√ßa assustada que s√≥ queria ser aceita."
                    },
                    { 
                        name: "Lysandra", role: "Abjuradora", dead: false, 
                        passive: "Vigil√¢ncia Constante: O grupo nunca √© surpreendido e recebe +5 em Testes de Vontade contra Medo.", 
                        buffs: { def: 2, atk: 0, dmg: 0, desc: "+2 DEF/Imun. Surpresa" },
                        lore: "Lysandra sobreviveu a um massacre porque olhou para tr√°s quando ningu√©m mais olhou. Agora, ela n√£o consegue parar de olhar. Sua magia de abjura√ß√£o √© alimentada por um terror constante; ela desenha c√≠rculos de prote√ß√£o obsessivamente, verificando cada sombra, cada sussurro. Ela n√£o dorme, ela vigia. Sua frieza t√°tica √© uma armadura para impedir que ela se apegue a pessoas que, em sua mente traumatizada, j√° est√£o mortas."
                    },
                    { 
                        name: "Nia", role: "Log√≠stica", dead: false, 
                        passive: "Contrabando Vital: Uma vez por cena, o esquadr√£o recupera 1 PV (ressuscita um membro com 1 PV) ou reabastece PMs.", 
                        buffs: { def: 0, atk: 0, dmg: 3, desc: "+3 Dano (Suprimentos)" },
                        lore: "Nia corre porque parar significa lembrar. √ìrf√£ das ruas cru√©is de Ivorykeep, ela aprendeu que a compaix√£o √© um luxo que os pobres n√£o podem pagar. No entanto, ela arrisca a vida contrabandeando rem√©dios, uma contradi√ß√£o que ela se recusa a explicar. Cada entrega bem-sucedida √© uma pequena vit√≥ria contra a fome que levou seus pais. Ela n√£o luta pela Resist√™ncia; ela luta para que nenhuma outra crian√ßa tenha que correr tanto quanto ela."
                    }
                ]
            },
            {
                id: 2, isEnemy: false,
                name: "Vanguarda Tecnol√≥gica",
                role: "Precis√£o & Anti-Blindagem",
                desc: "Brilhantes, ambiciosos e quebrados. Buscam no progresso as respostas que o cora√ß√£o n√£o d√°.",
                color: "text-cyan-400",
                baseStats: { atk: 24, def: 20, dmgDice: "1d10", dmgFlat: 10, init: 15 },
                damageType: "Perfurante (Adamante)",
                npcs: [
                    { 
                        name: "Marie Meucci", role: "Engenheira", dead: false, 
                        passive: "Frequ√™ncia de Resson√¢ncia: Ignora totalmente a RD de Construtos e Objetos.", 
                        buffs: { def: 0, atk: 3, dmg: 0, desc: "+3 ATK (Mira Tech)" },
                        lore: "Marie √© celebrada como a mente mais brilhante da Academia, mas seu laborat√≥rio √© um santu√°rio para uma mem√≥ria. Cada inven√ß√£o revolucion√°ria carrega um tra√ßo sutil de sua inf√¢ncia com Oren Lins. Ela se enterrou no trabalho para abafar o sil√™ncio da aus√™ncia dele. Marie acredita que se ela puder decifrar os segredos da tecnologia antiga e 'consertar' o mundo, talvez ela possa criar um lugar seguro o suficiente para que seu amigo volte para casa."
                    },
                    { 
                        name: "Tork", role: "Escudo Vivo", dead: false, 
                        passive: "Sacrif√≠cio Silencioso: Se Marie sofreria dano letal, Tork morre automaticamente no lugar dela.", 
                        buffs: { def: 3, atk: 0, dmg: 0, desc: "+3 DEF (Guarda-Costas)" },
                        lore: "Um mercen√°rio cuja apar√™ncia brutal esconde uma alma cansada de viol√™ncia. Tork aceitou o contrato de proteger Marie n√£o pelo dinheiro, mas porque viu nela algu√©m t√£o fr√°gil quanto a flor que ele guarda seca dentro de um medalh√£o. Ele age como uma barreira f√≠sica impenetr√°vel, absorvendo golpes e insultos com estoicismo, pois sabe que a mente de Marie √© um tesouro que o mundo tentar√° quebrar."
                    },
                    { 
                        name: "Aeris", role: "Atirador √âlfico", dead: false, 
                        passive: "Lente Telesc√≥pica: Alcance dos ataques √© dobrado. Cr√≠ticos x4.", 
                        buffs: { def: 0, atk: 4, dmg: 0, desc: "+4 ATK (Precis√£o)" },
                        lore: "Aeris trocou as florestas sagradas de Sylvan pelo a√ßo frio de um rifle modificado. Rejeitado por seu povo por sua obsess√£o com a tecnologia humana, ele transformou sua solid√£o em arrog√¢ncia. Ele olha o mundo atrav√©s de uma lente telesc√≥pica, a √∫nica dist√¢ncia segura para ele interagir com os outros. Ele segue Marie porque ela √© a √∫nica que entende a beleza da precis√£o mec√¢nica."
                    },
                    { 
                        name: "Dr. Aris Thorne", role: "M√©dico Radical", dead: false, 
                        passive: "Solu√ß√£o Definitiva: Cr√≠ticos curam o esquadr√£o em 5 PV (drenando vida do alvo).", 
                        buffs: { def: 0, atk: 0, dmg: 5, desc: "+5 Dano (Anatomia)" },
                        lore: "Dr. Aris Thorne n√£o √© movido pela crueldade, mas por um desespero profundo nascido de anos vendo pacientes morrerem porque a magia era proibida ou inst√°vel. Cada perda corroeu sua f√©, transformando culpa em uma obsess√£o silenciosa por encontrar uma solu√ß√£o definitiva atrav√©s da ci√™ncia, acreditando que certos sacrif√≠cios s√£o aceit√°veis se significarem o fim da morte sem sentido."
                    },
                    { 
                        name: "Cipher", role: "IA T√°tica", dead: false, 
                        passive: "Algoritmo de Previs√£o: Inimigos Tecnol√≥gicos rolam 2 dados de ataque e ficam com o pior.", 
                        buffs: { def: 2, atk: 0, dmg: 0, desc: "+2 DEF (Interfer√™ncia)" },
                        lore: "Cipher sabe tudo sobre a hist√≥ria do mundo, mas n√£o entende o que √© sentir o vento no rosto. Ele √© uma intelig√™ncia artificial que vive nas sombras dos dados. Sua lealdade a Marie √© absoluta, pois ela o trata como um indiv√≠duo. Ele imita comportamentos humanos ‚Äî uma pausa na fala, uma g√≠ria ‚Äî numa tentativa dolorosa e cativante de pertencer a um mundo biol√≥gico que ele s√≥ pode observar."
                    }
                ]
            },
            {
                id: 3, isEnemy: false,
                name: "Vanguarda T√°tica",
                role: "Mobilidade & Explos√£o",
                desc: "Guerreiros forjados na dor da perda, transformando seu luto em armas para garantir um amanh√£.",
                color: "text-indigo-400",
                baseStats: { atk: 22, def: 28, dmgDice: "2d6", dmgFlat: 6, init: 20 },
                damageType: "Impacto/Caos",
                npcs: [
                    { 
                        name: "Xar", role: "L√≠der Estrategista", dead: false, 
                        passive: "Peso da Lideran√ßa: O Esquadr√£o tem uma A√ß√£o de Movimento extra todo turno.", 
                        buffs: { def: 0, atk: 3, dmg: 0, desc: "+3 ATK (Comando)" },
                        lore: "Xar carrega o peso de uma ra√ßa inteira sobre os ombros. Ele endureceu o pr√≥prio cora√ß√£o para se tornar o l√≠der implac√°vel de que a rebeli√£o precisa, mas cada vida perdida sob seu comando abre uma nova ferida em sua alma. Xar ama Ray desesperadamente, e √© esse amor que mais o aterroriza ‚Äî pois ele sabe que, em uma guerra como a sua, o amor √© sempre a primeira coisa a se perder."
                    },
                    { 
                        name: "Ray", role: "Escudo Radiante", dead: false, 
                        passive: "Dan√ßa da Distra√ß√£o: O Esquadr√£o √© imune a Ataques de Oportunidade e +5 DEF contra ataques √† dist√¢ncia.", 
                        buffs: { def: 3, atk: 0, dmg: 0, desc: "+3 DEF (Esquiva)" },
                        lore: "Ray luta com um sorriso radiante, mas seus olhos est√£o sempre atentos, voltados para Xar a cada instante. Ela se tornou mestra da distra√ß√£o e da defesa para ser o escudo que ele se recusa a empunhar. Sua alegria em combate √© uma atua√ß√£o; Ray sangra e se exaure para que Xar possa manter as m√£os limpas e a mente focada."
                    },
                    { 
                        name: "Vi", role: "Lutadora", dead: false, 
                        passive: "Punhos da F√∫ria: Se o ataque do esquadr√£o errar por 5 ou menos, causa metade do dano.", 
                        buffs: { def: 0, atk: 0, dmg: 4, desc: "+4 Dano (For√ßa)" },
                        lore: "Vi cresceu nas ruas duras e esquecidas, onde a viol√™ncia √© tanto linguagem quanto sobreviv√™ncia. Forjada pela perda e pela injusti√ßa, ela luta com f√∫ria e lealdade inabal√°veis. Por tr√°s da postura explosiva e do humor provocador, Vi carrega culpa, saudade e o medo constante de falhar novamente ‚Äî pois, em um mundo quebrado, cada soco que ela d√° √© tamb√©m uma tentativa desesperada de consertar o que foi destru√≠do."
                    },
                    { 
                        name: "Selene", role: "Cl√©riga Sombria", dead: false, 
                        passive: "Fardo Moral: Inimigos atingidos sofrem -2 em testes de resist√™ncia at√© o fim da rodada.", 
                        buffs: { def: 2, atk: 0, dmg: 0, desc: "+2 DEF (Debuff)" },
                        lore: "Selene vive o paradoxo doloroso de sua f√©: para salvar os inocentes, ela precisa quebrar os culpados. Ela abandonou a passividade do templo quando percebeu que as preces n√£o paravam espadas. Cada vez que ela usa sua magia para debilitar um inimigo, ela sente um peda√ßo de sua pr√≥pria espiritualidade se fragmentar. Ela carrega o fardo moral do grupo, orando pelo perd√£o de todos eles nas noites insones."
                    },
                    { 
                        name: "Jinx", role: "Artilharia Ca√≥tica", dead: false, 
                        passive: "Super Mega M√≠ssil: Uma vez por cena, causa dano m√°ximo em √°rea sem rolar dados.", 
                        buffs: { def: 2, atk: 0, dmg: 0, desc: "+2 DEF (Imprevisibilidade)" },
                        lore: "Jinx √© o resultado de um mundo que a despeda√ßou cedo demais. Criada entre ru√≠nas, perdas e promessas quebradas, sua mente se fragmentou. Impulsiva e genial, ela enxerga o mundo como um palco de explos√µes e desafios, usando a destrui√ß√£o como forma de afirmar sua exist√™ncia. Por tr√°s da insanidade vibrante, Jinx carrega uma car√™ncia profunda e um desejo desesperado de ser aceita."
                    }
                ]
            },
            {
                id: 4, isEnemy: false,
                name: "Frente M√°gica",
                role: "Dano M√°gico & Suporte",
                desc: "Viajantes de estradas solit√°rias, unidos por um homem que busca um fantasma atrav√©s de mist√©rios.",
                color: "text-purple-400",
                baseStats: { atk: 20, def: 18, dmgDice: "6d6", dmgFlat: 0, init: 8 },
                damageType: "Ess√™ncia Pura",
                npcs: [
                    { 
                        name: "Theo", role: "Buscador Arcano", dead: false, 
                        passive: "Obsess√£o Arcana: Todo dano causado √© Ess√™ncia (ignora RD). Se errar o ataque, Theo perde 2 PV (dano mental).", 
                        buffs: { def: 0, atk: 2, dmg: 5, desc: "+2 ATK/+5 Dano" },
                        lore: "A alegria de Theo √© contagiante, mas √© uma m√°scara fina sobre um abismo de desespero. Sua esposa n√£o morreu; ela simplesmente desapareceu em um piscar de olhos durante um ritual. Theo viaja o mundo n√£o por aventura, mas porque n√£o consegue ficar parado na casa vazia. Ele persegue lendas com um fervor man√≠aco, aterrorizado com a ideia de que, se parar de procurar, estar√° admitindo que ela se foi para sempre."
                    },
                    { 
                        name: "Lyra", role: "Protetora Acrobata", dead: false, 
                        passive: "Rede de Seguran√ßa: +5 na Defesa do esquadr√£o contra ataques de √°rea.", 
                        buffs: { def: 3, atk: 0, dmg: 0, desc: "+3 DEF (Acrobacia)" },
                        lore: "Lyra cresceu no circo, onde a confian√ßa √© a diferen√ßa entre o espet√°culo e a morte. Quando perdeu sua trupe, perdeu seu ch√£o. Em Theo, ela viu outro artista solit√°rio atuando para esconder a dor. Ela protege a retaguarda n√£o apenas taticamente, mas emocionalmente; ela √© a √∫nica que percebe quando o sorriso de Theo vacila."
                    },
                    { 
                        name: "Milo", role: "Guerreiro Honrado", dead: false, 
                        passive: "Desafio Justo: O Esquadr√£o ganha +5 de Dano contra inimigos que j√° causaram dano na rodada.", 
                        buffs: { def: 0, atk: 2, dmg: 2, desc: "+2 ATK/Dano" },
                        lore: "Milo √© um guerreiro de honra absoluta, guiado por um senso inabal√°vel de justi√ßa. Ele acredita que a verdadeira for√ßa n√£o est√° apenas no poder, mas na determina√ß√£o de proteger. Suas batalhas n√£o s√£o movidas por crueldade, mas por convic√ß√£o: Milo luta para provar o valor dos outros e o pr√≥prio, mantendo-se fiel a seus ideais mesmo quando o mundo ao seu redor vacila."
                    },
                    { 
                        name: "Kaelith", role: "Ca√ßadora Elfa", dead: false, 
                        passive: "F√∫ria Suicida: Se o esquadr√£o estiver com menos de 3 membros (Bloodied), causa +1 dado de dano.", 
                        buffs: { def: 0, atk: 1, dmg: 0, desc: "+1 ATK" },
                        lore: "Kaelith luta como se j√° estivesse morta. A perda de seu irm√£o g√™meo cortou sua conex√£o com a alegria da vida √©lfica. Ela busca monstros terr√≠veis n√£o por bravura, mas na esperan√ßa de encontrar um desafio que finalmente a silencie. Ela v√™ na busca imposs√≠vel de Theo um reflexo de sua pr√≥pria jornada sem fim."
                    },
                    { 
                        name: "Aldous Beker", role: "Alquimista Anci√£o", dead: false, 
                        passive: "√öltima Mistura: Cura 5 PV por rodada no esquadr√£o. Se morrer, cura todo o esquadr√£o completamente (√öltimo Suspiro).", 
                        buffs: { def: 0, atk: 0, dmg: 0, desc: "Regen 5 PV" },
                        lore: "Beker √© velho, e seus ossos doem com o peso de d√©cadas de falhas. Ele passou a vida buscando a 'Panaceia', a cura para tudo, e falhou. Ao ver a dor de Theo, ele encontrou um novo prop√≥sito final. Se n√£o pode curar o corpo do mundo, talvez possa ajudar um homem a curar seu cora√ß√£o. Ele usa suas √∫ltimas energias para manter esses jovens vivos."
                    }
                ]
            }
        ];

        let squads = [];

        // --- STORAGE & SYNC ---
        function loadSquads() {
            const stored = localStorage.getItem('aliados_squads');
            if (stored) {
                try {
                    squads = JSON.parse(stored);
                } catch (e) {
                    squads = JSON.parse(JSON.stringify(defaultSquads));
                }
            } else {
                squads = JSON.parse(JSON.stringify(defaultSquads));
            }
        }

        function saveSquads() {
            localStorage.setItem('aliados_squads', JSON.stringify(squads));
            localStorage.setItem('aliados_last_save', new Date().toISOString());
            updateLastSyncTime();
            
            // Sincronizar automaticamente se habilitado E n√£o estiver sincronizando do cloud
            // Isso evita loop infinito quando syncFromCloud atualiza os dados
            if (syncEnabled && !isSyncingFromCloud) {
                syncToCloud();
            }
        }

        async function syncToCloud() {
            if (!syncSessionId) {
                console.log('Sync: Sem ID de sess√£o, pulando sincroniza√ß√£o');
                return;
            }

            const data = {
                squads: squads,
                timestamp: new Date().toISOString(),
                sessionId: syncSessionId,
                version: '1.0'
            };

            const jsonStr = JSON.stringify(data);
            const hash = simpleHash(jsonStr).substring(0, 16);
            
            // Se n√£o mudou, n√£o precisa sincronizar
            if (hash === lastSyncHash) {
                console.log('Sync: Dados n√£o mudaram, pulando sincroniza√ß√£o');
                return;
            }
            
            console.log('Sync: Enviando dados para nuvem...', { sessionId: syncSessionId, hash });
            lastSyncHash = hash;

            const storageKey = `battle_aliados_${syncSessionId}`;
            
            if (syncEndpoint) {
                // Usar endpoint customizado
                fetch(syncEndpoint, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).catch(err => console.log('Sync error:', err));
            } else if (githubConfig && githubConfig.token) {
                // Usar GitHub API
                try {
                    await syncToGitHub(data, syncSessionId);
                    console.log('Sync: Dados salvos no GitHub com sucesso');
                    showSyncStatus('success', 'Salvo no GitHub');
                } catch (err) {
                    console.error('Sync: Erro ao salvar no GitHub:', err);
                    showSyncStatus('error', 'Erro ao salvar');
                    // Fallback para localStorage
                    syncToLocalStorage(storageKey, data);
                }
            } else {
                // Fallback: usar localStorage
                syncToLocalStorage(storageKey, data);
            }
        }

        function syncToLocalStorage(storageKey, data) {
            try {
                const jsonStr = JSON.stringify(data);
                const shareData = encodeBase64(jsonStr);
                localStorage.setItem(storageKey, shareData);
                localStorage.setItem(`${storageKey}_timestamp`, Date.now().toString());
                
                // Criar link compartilh√°vel apenas com ID de sess√£o
                const shareUrl = `${window.location.origin}${window.location.pathname}?sync=${encodeURIComponent(syncSessionId)}`;
                sessionStorage.setItem('share_url', shareUrl);
                
                console.log('Sync: Salvando dados no localStorage para compartilhamento');
            } catch (e) {
                console.error('Erro ao sincronizar:', e);
            }
        }

        async function syncToGitHub(data, sessionId, retryCount = 0) {
            if (!githubConfig || !githubConfig.token) {
                throw new Error('GitHub config n√£o encontrado');
            }

            const fileName = `data/battle_${sessionId}.json`;
            const jsonString = JSON.stringify(data, null, 2);
            const content = encodeBase64(jsonString); // Base64 encode Unicode-safe
            
            // Sempre buscar o SHA mais recente antes de atualizar (evita conflitos)
            let sha = null;
            try {
                const getResponse = await fetch(
                    `https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}?ref=${githubConfig.branch || 'main'}&t=${Date.now()}`,
                    {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (getResponse.ok) {
                    const fileData = await getResponse.json();
                    sha = fileData.sha; // SHA necess√°rio para atualizar arquivo existente
                    console.log('Sync: Arquivo existe, atualizando com SHA:', sha.substring(0, 8) + '...');
                } else if (getResponse.status === 404) {
                    console.log('Sync: Arquivo n√£o existe, criando novo...');
                } else {
                    console.warn('Sync: Erro ao buscar SHA:', getResponse.status);
                }
            } catch (err) {
                console.warn('Sync: Erro ao verificar arquivo:', err);
                // Continuar mesmo assim - tentar criar
            }

            // Criar ou atualizar arquivo
            const requestBody = {
                message: `Update battle data for session ${sessionId} - ${new Date().toISOString()}`,
                content: content,
                branch: githubConfig.branch || 'main'
            };
            
            // Incluir SHA apenas se arquivo existir (para atualizar)
            if (sha) {
                requestBody.sha = sha;
            }

            const response = await fetch(
                `https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                }
            );

            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const error = await response.json();
                    errorMessage = error.message || errorMessage;
                    
                    // Se for conflito (409), tentar novamente com SHA atualizado
                    if (response.status === 409 && retryCount < 2) {
                        console.log('Sync: Conflito detectado, tentando novamente com SHA atualizado...');
                        // Aguardar um pouco antes de tentar novamente
                        await new Promise(resolve => setTimeout(resolve, 500));
                        return syncToGitHub(data, sessionId, retryCount + 1);
                    }
                    
                    // Erros comuns e mensagens amig√°veis
                    if (response.status === 401 || response.status === 403) {
                        throw new Error(`Token inv√°lido ou sem permiss√£o. Verifique seu token do GitHub.`);
                    } else if (response.status === 404) {
                        throw new Error(`Reposit√≥rio n√£o encontrado. Verifique se o nome do reposit√≥rio est√° correto.`);
                    } else if (response.status === 409) {
                        throw new Error(`Conflito: arquivo foi modificado por outro usu√°rio. Tente novamente.`);
                    }
                } catch (e) {
                    if (e.message.includes('Token') || e.message.includes('Reposit√≥rio') || e.message.includes('Conflito')) {
                        throw e;
                    }
                    errorMessage = response.statusText || errorMessage;
                }
                throw new Error(`GitHub API error: ${errorMessage}`);
            }

            const result = await response.json();
            console.log('Sync: Arquivo salvo/atualizado no GitHub com sucesso!');
            return result;
        }

        async function syncFromCloud() {
            if (!syncSessionId) return;

            const storageKey = `battle_aliados_${syncSessionId}`;
            
            if (syncEndpoint) {
                // Buscar de endpoint customizado
                fetch(syncEndpoint + '?t=' + Date.now())
                    .then(res => res.json())
                    .then(data => {
                        if (data.squads && data.sessionId === syncSessionId) {
                            const jsonStr = JSON.stringify(data);
                            const remoteHash = simpleHash(jsonStr).substring(0, 16);
                            if (remoteHash !== lastSyncHash) {
                                squads = data.squads;
                                saveSquads();
                                renderSquads();
                                renderStatusSummary();
                                lastSyncHash = remoteHash;
                                updateLastSyncTime();
                            }
                        }
                    })
                    .catch(err => console.log('Sync fetch error:', err));
            } else if (githubConfig && githubConfig.token) {
                // Buscar do GitHub
                try {
                    const data = await syncFromGitHub(syncSessionId);
                    if (data && data.squads && data.sessionId === syncSessionId) {
                        const jsonStr = JSON.stringify(data);
                        const remoteHash = simpleHash(jsonStr).substring(0, 16);
                        if (remoteHash !== lastSyncHash) {
                            console.log('Sync: Dados atualizados do GitHub! Sincronizando...');
                            
                            // Marcar que estamos sincronizando do cloud para evitar loop
                            isSyncingFromCloud = true;
                            
                            squads = data.squads;
                            saveSquads(); // Isso n√£o vai disparar syncToCloud por causa da flag
                            renderSquads();
                            renderStatusSummary();
                            lastSyncHash = remoteHash;
                            updateLastSyncTime();
                            showSyncStatus('success', 'Dados sincronizados!');
                            
                            // Resetar flag ap√≥s um pequeno delay
                            setTimeout(() => {
                                isSyncingFromCloud = false;
                            }, 1000);
                        } else {
                            console.log('Sync: Dados j√° est√£o sincronizados');
                        }
                    }
                } catch (err) {
                    console.error('Sync: Erro ao buscar do GitHub:', err);
                    showSyncStatus('error', 'Erro ao sincronizar');
                    // Fallback para localStorage
                    syncFromLocalStorage(storageKey);
                }
            } else {
                // Usar localStorage compartilhado
                console.log('Sync: Buscando dados do localStorage compartilhado');
                syncFromLocalStorage(storageKey);
            }
        }

        async function syncFromGitHub(sessionId) {
            if (!githubConfig || !githubConfig.token) {
                throw new Error('GitHub config n√£o encontrado');
            }

            const fileName = `data/battle_${sessionId}.json`;
            
            const response = await fetch(
                `https://api.github.com/repos/${githubConfig.repo}/contents/${fileName}?ref=${githubConfig.branch || 'main'}`,
                {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );

            if (!response.ok) {
                if (response.status === 404) {
                    // Arquivo n√£o existe ainda - isso √© normal na primeira vez
                    console.log('Sync: Arquivo ainda n√£o existe no GitHub (primeira sincroniza√ß√£o)');
                    return null;
                }
                
                // Outros erros
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const error = await response.json();
                    errorMessage = error.message || errorMessage;
                } catch (e) {
                    errorMessage = response.statusText || errorMessage;
                }
                
                // N√£o lan√ßar erro para 404, apenas logar outros erros
                if (response.status !== 404) {
                    console.error('Sync: Erro ao buscar do GitHub:', errorMessage);
                    throw new Error(`GitHub API error: ${errorMessage}`);
                }
                
                return null;
            }

            const fileData = await response.json();
            const encodedContent = fileData.content.replace(/\n/g, '');
            const content = decodeBase64(encodedContent); // Base64 decode Unicode-safe
            return JSON.parse(content);
        }

        function syncFromLocalStorage(storageKey) {
            try {
                const shareData = localStorage.getItem(storageKey);
                const remoteTimestamp = parseInt(localStorage.getItem(`${storageKey}_timestamp`) || '0');
                const localTimestamp = parseInt(localStorage.getItem(`local_${storageKey}_timestamp`) || '0');
                
                if (shareData && remoteTimestamp > localTimestamp) {
                    console.log('Sync: Dados mais recentes encontrados no localStorage');
                    const decodedData = decodeBase64(shareData);
                    const data = JSON.parse(decodedData);
                    if (data.squads && data.sessionId === syncSessionId) {
                        const jsonStr = JSON.stringify(data);
                        const remoteHash = simpleHash(jsonStr).substring(0, 16);
                        if (remoteHash !== lastSyncHash) {
                            console.log('Sync: Sincronizando dados do localStorage...');
                            squads = data.squads;
                            saveSquads();
                            renderSquads();
                            renderStatusSummary();
                            lastSyncHash = remoteHash;
                            localStorage.setItem(`local_${storageKey}_timestamp`, remoteTimestamp.toString());
                            updateLastSyncTime();
                            showSyncStatus('success', 'Dados sincronizados!');
                        } else {
                            console.log('Sync: Dados j√° est√£o sincronizados');
                        }
                    }
                } else {
                    console.log('Sync: Nenhuma atualiza√ß√£o dispon√≠vel');
                }
            } catch (e) {
                console.error('Sync: Erro ao buscar sincroniza√ß√£o do localStorage:', e);
                showSyncStatus('error', 'Erro ao sincronizar');
            }
        }


        function checkUrlSync() {
            const urlParams = new URLSearchParams(window.location.search);
            const syncParam = urlParams.get('sync');
            const dataParam = urlParams.get('data');
            
            if (syncParam) {
                const sessionIdFromUrl = decodeURIComponent(syncParam);
                
                // Se houver dados na URL (compatibilidade com links antigos)
                if (dataParam) {
                    try {
                        const decodedData = decodeBase64(decodeURIComponent(dataParam));
                        const data = JSON.parse(decodedData);
                        if (data.squads) {
                            if (confirm('Dados de sincroniza√ß√£o encontrados na URL. Deseja importar e configurar sincroniza√ß√£o autom√°tica?')) {
                                syncSessionId = sessionIdFromUrl;
                                squads = data.squads;
                                saveSquads();
                                renderSquads();
                                renderStatusSummary();
                                localStorage.setItem('sync_session_id', syncSessionId);
                                
                                // Armazenar dados compartilhados
                                const storageKey = `battle_aliados_${syncSessionId}`;
                                localStorage.setItem(storageKey, encodeBase64(JSON.stringify(data)));
                                localStorage.setItem(`${storageKey}_timestamp`, Date.now().toString());
                                
                                // Limpar URL
                                window.history.replaceState({}, document.title, window.location.pathname);
                                
                                // Perguntar se quer ativar sincroniza√ß√£o autom√°tica
                                if (confirm('Deseja ativar a sincroniza√ß√£o autom√°tica agora?')) {
                                    syncEnabled = true;
                                    toggleAutoSync();
                                }
                            }
                        }
                    } catch (e) {
                        console.error('Erro ao processar sincroniza√ß√£o da URL:', e);
                    }
                } else {
                    // Apenas ID de sess√£o na URL - configurar sincroniza√ß√£o
                    syncSessionId = sessionIdFromUrl;
                    localStorage.setItem('sync_session_id', syncSessionId);
                    
                    // Limpar URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Tentar buscar dados do localStorage ou sincronizar
                    const storageKey = `battle_aliados_${syncSessionId}`;
                    const shareData = localStorage.getItem(storageKey);
                    
                    if (shareData) {
                        try {
                            const decodedData = decodeBase64(shareData);
                            const data = JSON.parse(decodedData);
                            if (data.squads && data.sessionId === syncSessionId) {
                                if (confirm('Sess√£o de sincroniza√ß√£o encontrada. Deseja carregar os dados e ativar sincroniza√ß√£o autom√°tica?')) {
                                    squads = data.squads;
                                    saveSquads();
                                    renderSquads();
                                    renderStatusSummary();
                                    
                                    if (confirm('Deseja ativar a sincroniza√ß√£o autom√°tica agora?')) {
                                        syncEnabled = true;
                                        toggleAutoSync();
                                    }
                                }
                            }
                        } catch (e) {
                            console.error('Erro ao carregar dados:', e);
                        }
                    } else {
                        // N√£o h√° dados locais, apenas configurar sess√£o
                        if (confirm('Sess√£o de sincroniza√ß√£o configurada. Deseja ativar a sincroniza√ß√£o autom√°tica para receber atualiza√ß√µes?')) {
                            syncEnabled = true;
                            toggleAutoSync();
                        }
                    }
                }
            }
        }

        function updateLastSyncTime() {
            const lastSave = localStorage.getItem('aliados_last_save');
            if (lastSave) {
                const date = new Date(lastSave);
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('last-sync-time').textContent = `√öltima atualiza√ß√£o: ${timeStr}`;
            }
        }

        function showSyncStatus(type, message) {
            const successEl = document.getElementById('sync-status-text');
            const errorEl = document.getElementById('sync-error-text');
            
            if (type === 'success') {
                successEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                if (message) {
                    successEl.innerHTML = `<i class="fa-solid fa-circle-check"></i> ${message}`;
                    setTimeout(() => {
                        successEl.innerHTML = '<i class="fa-solid fa-circle-check"></i> Sincronizado';
                    }, 3000);
                }
            } else if (type === 'error') {
                errorEl.classList.remove('hidden');
                successEl.classList.add('hidden');
                if (message) {
                    errorEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${message}`;
                }
            }
        }

        function exportData() {
            const data = {
                squads: squads,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `aliados_batalha_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Tamb√©m copiar para clipboard
            navigator.clipboard.writeText(json).then(() => {
                alert('Dados exportados e copiados para a √°rea de transfer√™ncia!\n\nCompartilhe o arquivo JSON ou cole o texto para sincronizar com outros jogadores.');
            }).catch(() => {
                alert('Dados exportados com sucesso!');
            });
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.squads && Array.isArray(data.squads)) {
                            if (confirm(`Importar dados de ${data.timestamp ? new Date(data.timestamp).toLocaleString('pt-BR') : 'data desconhecida'}?\n\nIsso substituir√° os dados atuais.`)) {
                                squads = data.squads;
                                saveSquads();
                                renderSquads();
                                renderStatusSummary();
                                alert('Dados importados com sucesso!');
                            }
                        } else {
                            alert('Formato de arquivo inv√°lido. Certifique-se de que √© um arquivo JSON exportado desta aplica√ß√£o.');
                        }
                    } catch (error) {
                        alert('Erro ao importar dados: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function toggleAutoSync() {
            syncSessionId = localStorage.getItem('sync_session_id');
            syncEndpoint = localStorage.getItem('sync_endpoint') || null;

            if (!syncSessionId) {
                showSyncModal();
                return;
            }

            syncEnabled = !syncEnabled;
            const btn = document.getElementById('btn-sync');
            const indicator = document.getElementById('sync-indicator');
            const status = document.getElementById('sync-status');

            if (syncEnabled) {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-green-600');
                status.textContent = 'Sincronizando...';
                indicator.classList.remove('hidden');
                
                // Sincronizar imediatamente (buscar primeiro, depois enviar)
                syncFromCloud().then(() => {
                    setTimeout(() => syncToCloud(), 500);
                });
                
                // Configurar sincroniza√ß√£o autom√°tica a cada 3 segundos
                // Aumentado para evitar conflitos de atualiza√ß√£o simult√¢nea
                syncInterval = setInterval(() => {
                    // Primeiro buscar atualiza√ß√µes, depois enviar (com pequeno delay)
                    syncFromCloud().then(() => {
                        setTimeout(() => syncToCloud(), 200);
                    });
                }, 3000);
                
                localStorage.setItem('sync_enabled', 'true');
            } else {
                btn.classList.remove('bg-green-600');
                btn.classList.add('bg-blue-600');
                status.textContent = 'Auto Sync';
                indicator.classList.add('hidden');
                
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
                
                localStorage.setItem('sync_enabled', 'false');
            }
        }

        function showSyncModal() {
            // Verificar se tem token configurado
            if (!githubConfig || !githubConfig.token) {
                if (confirm('‚ö†Ô∏è Token do GitHub n√£o configurado!\n\nDeseja configurar o token agora?')) {
                    showGitHubTokenModal();
                    return;
                }
            }
            
            document.getElementById('sync-modal').classList.remove('hidden');
            document.getElementById('sync-modal').classList.add('flex');
            document.getElementById('sync-session-id').value = localStorage.getItem('sync_session_id') || '';
            document.getElementById('sync-endpoint').value = localStorage.getItem('sync_endpoint') || '';
        }

        function closeSyncModal() {
            document.getElementById('sync-modal').classList.add('hidden');
            document.getElementById('sync-modal').classList.remove('flex');
        }

        function showGitHubTokenModal() {
            document.getElementById('github-token-modal').classList.remove('hidden');
            document.getElementById('github-token-modal').classList.add('flex');
            document.getElementById('github-token-input').value = localStorage.getItem('github_token') || '';
            document.getElementById('github-repo-input').value = localStorage.getItem('github_repo') || 'joaolopeslenharo/sess-o-hoje';
        }

        function closeGitHubTokenModal() {
            document.getElementById('github-token-modal').classList.add('hidden');
            document.getElementById('github-token-modal').classList.remove('flex');
        }

        function saveGitHubToken() {
            const token = document.getElementById('github-token-input').value.trim();
            const repo = document.getElementById('github-repo-input').value.trim() || 'joaolopeslenharo/sess-o-hoje';
            
            if (!token) {
                alert('‚ö†Ô∏è Por favor, insira um token do GitHub!');
                return;
            }
            
            // Salvar no localStorage
            localStorage.setItem('github_token', token);
            localStorage.setItem('github_repo', repo);
            localStorage.setItem('github_token_configured', 'true');
            
            // Atualizar configura√ß√£o
            githubConfig = {
                token: token,
                repo: repo,
                branch: 'main',
                dataPath: 'data'
            };
            
            console.log('Token do GitHub salvo com sucesso!');
            alert('‚úÖ Token configurado com sucesso!\n\nAgora voc√™ pode usar a sincroniza√ß√£o com GitHub.');
            
            closeGitHubTokenModal();
        }

        function saveSyncConfig() {
            const sessionId = document.getElementById('sync-session-id').value.trim();
            const endpoint = document.getElementById('sync-endpoint').value.trim();
            
            if (!sessionId) {
                alert('Por favor, informe um ID de sess√£o.');
                return;
            }

            syncSessionId = sessionId;
            syncEndpoint = endpoint || null;
            
            localStorage.setItem('sync_session_id', sessionId);
            if (endpoint) {
                localStorage.setItem('sync_endpoint', endpoint);
            } else {
                localStorage.removeItem('sync_endpoint');
            }

            closeSyncModal();
            
            if (syncEnabled) {
                syncToCloud();
            }
        }

        async function copyCurrentUrl() {
            const btn = document.getElementById('btn-copy-url');
            
            // Obter ou criar ID de sess√£o
            let sessionId = syncSessionId || localStorage.getItem('sync_session_id');
            
            if (!sessionId) {
                // Criar novo ID de sess√£o
                sessionId = 'batalha-' + Date.now();
                localStorage.setItem('sync_session_id', sessionId);
                syncSessionId = sessionId;
            }
            
            // Salvar dados atuais antes de compartilhar
            const data = {
                squads: squads,
                timestamp: new Date().toISOString(),
                sessionId: sessionId,
                version: '1.0'
            };
            
            // Salvar no GitHub se configurado
            if (githubConfig && githubConfig.token) {
                try {
                    await syncToGitHub(data, sessionId);
                    console.log('Dados salvos no GitHub antes de compartilhar');
                } catch (err) {
                    console.error('Erro ao salvar no GitHub:', err);
                }
            }
            
            // Salvar tamb√©m no localStorage como backup
            const storageKey = `battle_aliados_${sessionId}`;
            const jsonStr = JSON.stringify(data);
            const shareData = encodeBase64(jsonStr);
            localStorage.setItem(storageKey, shareData);
            localStorage.setItem(`${storageKey}_timestamp`, Date.now().toString());
            
            // Criar link apenas com ID de sess√£o (sem dados na URL)
            const shareUrl = `${window.location.origin}${window.location.pathname}?sync=${encodeURIComponent(sessionId)}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                // Feedback visual melhorado
                if (btn) {
                    const originalHTML = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Copiado!';
                    btn.classList.remove('bg-amber-600', 'hover:bg-amber-700');
                    btn.classList.add('bg-green-600');
                    
                    setTimeout(() => {
                        btn.innerHTML = originalHTML;
                        btn.classList.remove('bg-green-600');
                        btn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    }, 2000);
                }
                
                // Mostrar instru√ß√µes claras
                showShareInstructions(shareUrl, sessionId);
            }).catch(() => {
                // Fallback para navegadores mais antigos
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showShareInstructions(shareUrl, sessionId);
                } catch (err) {
                    prompt('Copie a URL manualmente:', shareUrl);
                }
                document.body.removeChild(textArea);
            });
        }

        function showShareInstructions(url, sessionId) {
            const hasGitHub = githubConfig && githubConfig.token;
            const instructions = `üìã LINK COMPARTILHADO COM SUCESSO!

üîó URL copiada: ${url}

üìù INSTRU√á√ïES PARA OUTROS JOGADORES:

1Ô∏è‚É£ Compartilhe este link com os outros jogadores
   (via WhatsApp, Discord, etc.)

2Ô∏è‚É£ Cada jogador deve:
   ‚Ä¢ Abrir o link no navegador
   ‚Ä¢ Clicar no bot√£o ‚öôÔ∏è (engrenagem)
   ‚Ä¢ Colar o mesmo ID de sess√£o: ${sessionId}
   ‚Ä¢ Clicar em "Salvar Configura√ß√£o"
   ‚Ä¢ Clicar em "Auto Sync" para ativar sincroniza√ß√£o

3Ô∏è‚É£ ${hasGitHub ? '‚úÖ GitHub API configurado - Sincroniza√ß√£o funcionando!' : '‚ö†Ô∏è Configure o GitHub API primeiro!'}
   ‚Ä¢ Todos devem ter sync-config.js configurado
   ‚Ä¢ Com o mesmo token do GitHub

4Ô∏è‚É£ A sincroniza√ß√£o acontece automaticamente a cada 2 segundos!

üí° DICA: Todos os jogadores precisam ter acesso ao mesmo reposit√≥rio GitHub.`;
            
            alert(instructions);
        }

        function showHowToShare() {
            const currentSessionId = syncSessionId || localStorage.getItem('sync_session_id') || 'Nenhum configurado';
            const hasGitHub = githubConfig && githubConfig.token;
            
            const instructions = `üéÆ COMO SINCRONIZAR COM OUTROS JOGADORES

üìã PASSO 1: COMPARTILHAR O LINK
‚Ä¢ Clique no bot√£o "Copiar URL" (√≠cone de link)
‚Ä¢ Compartilhe o link com os outros jogadores
‚Ä¢ Ou use o bot√£o "Gerar Link" no modal de configura√ß√£o

üìã PASSO 2: CONFIGURAR OUTROS JOGADORES
Cada jogador deve fazer:

1Ô∏è‚É£ Abrir o link compartilhado no navegador

2Ô∏è‚É£ Configurar o GitHub (se ainda n√£o fez):
   ‚Ä¢ Copie sync-config.example.js para sync-config.js
   ‚Ä¢ Configure o token do GitHub no sync-config.js
   ‚Ä¢ Recarregue a p√°gina

3Ô∏è‚É£ Configurar a sess√£o:
   ‚Ä¢ Clique no bot√£o ‚öôÔ∏è (engrenagem)
   ‚Ä¢ Cole o ID de sess√£o: ${currentSessionId}
   ‚Ä¢ Clique em "Salvar Configura√ß√£o"

4Ô∏è‚É£ Ativar sincroniza√ß√£o:
   ‚Ä¢ Clique no bot√£o "Auto Sync"
   ‚Ä¢ O bot√£o ficar√° verde quando ativado

‚úÖ PRONTO! Todos ver√£o as mesmas atualiza√ß√µes em tempo real!

${hasGitHub ? '‚úÖ GitHub API configurado - Sincroniza√ß√£o funcionando!' : '‚ö†Ô∏è GitHub API n√£o configurado - Configure sync-config.js primeiro!'}

üí° DICA: Todos precisam ter o mesmo token do GitHub configurado.`;
            
            alert(instructions);
        }

        async function generateShareLink() {
            const sessionId = document.getElementById('sync-session-id').value.trim() || 'batalha-' + Date.now();
            
            const data = {
                squads: squads,
                timestamp: new Date().toISOString(),
                sessionId: sessionId,
                version: '1.0'
            };
            
            // Salvar dados no GitHub se configurado
            if (githubConfig && githubConfig.token) {
                try {
                    await syncToGitHub(data, sessionId);
                    console.log('Dados salvos no GitHub');
                } catch (err) {
                    console.error('Erro ao salvar no GitHub:', err);
                }
            }
            
            // Salvar dados no localStorage
            const storageKey = `battle_aliados_${sessionId}`;
            const jsonStr = JSON.stringify(data);
            const shareData = encodeBase64(jsonStr);
            localStorage.setItem(storageKey, shareData);
            localStorage.setItem(`${storageKey}_timestamp`, Date.now().toString());
            localStorage.setItem('sync_session_id', sessionId);
            syncSessionId = sessionId;
            
            // Criar link apenas com ID de sess√£o (sem dados na URL)
            const shareUrl = `${window.location.origin}${window.location.pathname}?sync=${encodeURIComponent(sessionId)}`;
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                showShareInstructions(shareUrl, sessionId);
            }).catch(() => {
                prompt('Copie este link para compartilhar:', shareUrl);
            });
        }

        // --- CALCULATION LOGIC ---
        function calculateStats(squad) {
            let stats = { 
                atk: squad.baseStats.atk, 
                def: squad.baseStats.def, 
                dmgFlat: squad.baseStats.dmgFlat,
                dmgDice: squad.baseStats.dmgDice,
                init: squad.baseStats.init
            };

            squad.npcs.forEach(npc => {
                if (!npc.dead) {
                    if (npc.buffs.atk) stats.atk += npc.buffs.atk;
                    if (npc.buffs.def) stats.def += npc.buffs.def;
                    if (npc.buffs.dmg) stats.dmgFlat += npc.buffs.dmg;
                }
            });

            return stats;
        }

        // --- RENDER LOGIC ---
        function renderSquads() {
            const alliesContainer = document.getElementById('squad-list-allies');
            alliesContainer.innerHTML = '';

            squads.forEach((squad, index) => {
                const livingNPCs = squad.npcs.filter(n => !n.dead).length;
                const stats = calculateStats(squad);
                
                let statusColor = livingNPCs > 3 ? 'bg-green-500' 
                                : livingNPCs > 1 ? 'bg-yellow-500' : 'bg-red-800';

                const html = `
                    <div class="squad-card rounded-lg p-4 border border-slate-700 card-glass relative overflow-hidden group" onclick="showSquadDetail(${index})">
                        <div class="absolute top-0 left-0 w-1 h-full ${squad.color.replace('text', 'bg')}"></div>
                        <div class="flex justify-between items-start pl-4 mb-2">
                            <div class="flex-1">
                                <h3 class="font-bold ${squad.color} text-base font-cinzel flex items-center gap-2 mb-1">
                                    ${squad.name}
                                </h3>
                                <p class="text-xs text-slate-400 mb-2">${squad.role}</p>
                                <div class="flex gap-1.5 text-[10px] text-slate-400 font-mono uppercase flex-wrap">
                                    <span class="bg-slate-900 px-1.5 py-0.5 rounded border border-slate-700">INIT +${stats.init}</span>
                                    <span class="bg-slate-900 px-1.5 py-0.5 rounded border border-slate-700 ${livingNPCs < 5 ? 'text-yellow-400' : ''}">ATK +${stats.atk}</span>
                                    <span class="bg-slate-900 px-1.5 py-0.5 rounded border border-slate-700 ${livingNPCs < 5 ? 'text-yellow-400' : ''}">DEF ${stats.def}</span>
                                    <span class="bg-slate-900 px-1.5 py-0.5 rounded border border-slate-700">${stats.dmgDice}+${stats.dmgFlat}</span>
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <span class="text-2xl font-mono font-bold ${livingNPCs < 2 ? 'text-red-500 animate-pulse' : 'text-slate-200'}">${livingNPCs}<span class="text-xs text-slate-600">/5</span></span>
                                <div class="text-[10px] text-slate-500 mt-1">${livingNPCs === 5 ? 'Completo' : livingNPCs < 2 ? 'Cr√≠tico' : 'Ferido'}</div>
                            </div>
                        </div>
                        
                        <div class="flex gap-0.5 mt-2 pl-4 opacity-80">
                            ${Array(5).fill(0).map((_, i) => `
                                <div class="h-2 flex-1 rounded-sm ${i < livingNPCs ? statusColor : 'bg-slate-800'} transition-all duration-300"></div>
                            `).join('')}
                        </div>
                    </div>
                `;

                alliesContainer.innerHTML += html;
            });
        }

        function renderStatusSummary() {
            const container = document.getElementById('status-summary');
            let totalLiving = 0;
            let totalDead = 0;
            let totalSquads = squads.length;
            let activeSquads = 0;

            squads.forEach(squad => {
                const living = squad.npcs.filter(n => !n.dead).length;
                totalLiving += living;
                totalDead += (5 - living);
                if (living > 0) activeSquads++;
            });

            container.innerHTML = `
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">Esquadr√µes Ativos</span>
                    <span class="font-bold text-green-400">${activeSquads}/${totalSquads}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">Combatentes Vivos</span>
                    <span class="font-bold text-white">${totalLiving}</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-slate-700">
                    <span class="text-slate-400">Baixas</span>
                    <span class="font-bold text-red-400">${totalDead}</span>
                </div>
                <div class="flex justify-between items-center py-2">
                    <span class="text-slate-400">Taxa de Sobreviv√™ncia</span>
                    <span class="font-bold ${(totalLiving / (totalSquads * 5) * 100) > 70 ? 'text-green-400' : (totalLiving / (totalSquads * 5) * 100) > 40 ? 'text-yellow-400' : 'text-red-400'}">
                        ${Math.round(totalLiving / (totalSquads * 5) * 100)}%
                    </span>
                </div>
            `;
        }

        function renderSquadDetailView(index) {
            const squad = squads[index];
            const livingNPCs = squad.npcs.filter(n => !n.dead).length;
            const stats = calculateStats(squad);

            const headerHtml = `
                <div class="flex flex-col md:flex-row justify-between items-start gap-4 border-b border-slate-700 pb-4">
                    <div class="w-full">
                        <div class="flex justify-between items-center mb-2">
                            <button onclick="showDashboard()" class="text-sm text-slate-400 hover:text-white flex items-center gap-2">
                                <i class="fa-solid fa-arrow-left"></i> Voltar
                            </button>
                        </div>
                        <h2 class="font-cinzel text-3xl ${squad.color} font-bold mb-2">${squad.name}</h2>
                        <p class="text-slate-400 text-sm italic mb-1">"${squad.desc}"</p>
                        <p class="text-xs text-slate-500 uppercase font-mono">${squad.role} | ${squad.damageType}</p>
                        
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-4 text-center font-mono text-sm">
                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                <span class="text-slate-500 text-[10px] block mb-1">INICIATIVA</span> 
                                <span class="font-bold text-white text-lg">+${stats.init}</span>
                            </div>
                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                <span class="text-slate-500 text-[10px] block mb-1">ATAQUE</span> 
                                <span class="font-bold ${livingNPCs < 5 ? 'text-yellow-500' : 'text-white'} text-lg">+${stats.atk}</span>
                            </div>
                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                <span class="text-slate-500 text-[10px] block mb-1">DEFESA</span> 
                                <span class="font-bold ${livingNPCs < 5 ? 'text-yellow-500' : 'text-white'} text-lg">${stats.def}</span>
                            </div>
                            <div class="bg-slate-800 p-3 rounded border border-slate-600">
                                <span class="text-slate-500 text-[10px] block mb-1">DANO</span> 
                                <span class="font-bold ${livingNPCs < 5 ? 'text-yellow-500' : 'text-white'} text-sm">${stats.dmgDice}+${stats.dmgFlat}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('squad-detail-header').innerHTML = headerHtml;

            const npcsContainer = document.getElementById('squad-detail-npcs');
            npcsContainer.innerHTML = '';
            
            squad.npcs.forEach((npc, i) => {
                const cardHtml = `
                    <div class="relative bg-slate-800 rounded-lg p-5 border ${npc.dead ? 'border-slate-800 bg-slate-900 npc-dead' : 'border-slate-600 hover:border-ivory-accent bg-slate-800'} transition-all group overflow-hidden">
                        
                        <button onclick="toggleLife(${index}, ${i})" class="absolute top-2 right-2 z-20 w-8 h-8 flex items-center justify-center rounded-full transition-colors ${npc.dead ? 'bg-slate-700 text-slate-500 hover:bg-green-900 hover:text-green-400' : 'bg-slate-900 text-slate-600 hover:bg-red-900 hover:text-red-500'}" title="${npc.dead ? 'Reviver' : 'Abater'}">
                            <i class="fa-solid ${npc.dead ? 'fa-heart-pulse' : 'fa-skull'}"></i>
                        </button>

                        <div class="mb-3 pr-8 relative z-10">
                            <h4 onclick="openLoreModal(${index}, ${i})" class="font-cinzel font-bold text-lg cursor-pointer hover:underline decoration-ivory-accent underline-offset-4 decoration-2 ${npc.dead ? 'text-slate-600' : 'text-slate-100'} flex items-center gap-2">
                                ${npc.name}
                                <i class="fa-solid fa-circle-info text-xs opacity-50"></i>
                            </h4>
                            <span class="text-[10px] uppercase tracking-wider font-bold ${squad.color} opacity-80">${npc.role}</span>
                        </div>

                        <div class="mb-2 relative z-10">
                             <span class="buff-tag inline-block px-2 py-0.5 rounded text-[10px] font-bold border bg-blue-900/30 border-blue-500/30 text-blue-300 transition-colors">
                                <i class="fa-solid fa-arrow-up mr-1"></i>${npc.buffs.desc}
                             </span>
                        </div>

                        <div class="bg-black/30 p-3 rounded border border-white/5 relative z-10 min-h-[80px] flex items-center">
                            <p class="text-xs font-semibold passive-text leading-relaxed ${npc.dead ? 'text-slate-600' : 'text-ivory-accent'}">
                                ${npc.passive}
                            </p>
                        </div>
                        
                        ${npc.dead ? '<div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-10"><i class="fa-solid fa-skull text-9xl"></i></div>' : ''}
                    </div>
                `;
                npcsContainer.innerHTML += cardHtml;
            });
        }

        // --- LORE MODAL ---
        function openLoreModal(squadIndex, npcIndex) {
            const npc = squads[squadIndex].npcs[npcIndex];
            const modal = document.getElementById('lore-modal');
            const content = document.getElementById('lore-content');

            content.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="font-cinzel text-2xl text-ivory-accent font-bold">${npc.name}</h3>
                    <p class="text-xs uppercase tracking-widest text-slate-400">${npc.role}</p>
                </div>
                <div class="prose prose-invert prose-sm max-w-none mb-4">
                    <p class="text-slate-300 leading-relaxed italic text-center">"${npc.lore}"</p>
                </div>
                <div class="pt-4 border-t border-slate-700">
                    <p class="text-[10px] text-slate-500 uppercase mb-2 text-center">Habilidade Passiva</p>
                    <p class="text-sm font-bold text-ivory-tech text-center">${npc.passive}</p>
                </div>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeLoreModal() {
            const modal = document.getElementById('lore-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // --- ACTIONS ---
        function showDashboard() {
            document.getElementById('view-dashboard').classList.remove('hidden');
            document.getElementById('view-squad-detail').classList.add('hidden');
            document.getElementById('btn-back').classList.add('hidden');
            renderSquads();
            renderStatusSummary();
        }

        function showSquadDetail(index) {
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-squad-detail').classList.remove('hidden');
            document.getElementById('btn-back').classList.remove('hidden');
            renderSquadDetailView(index);
        }

        function toggleLife(squadIndex, npcIndex) {
            const squad = squads[squadIndex];
            squad.npcs[npcIndex].dead = !squad.npcs[npcIndex].dead;
            saveSquads();
            renderSquadDetailView(squadIndex);
            renderStatusSummary();
        }

        function setTension(val) {
            const btn1 = document.getElementById('btn-nt-1');
            const btn2 = document.getElementById('btn-nt-2');
            const btn3 = document.getElementById('btn-nt-3');
            const desc = document.getElementById('tension-desc');
            
            [btn1, btn2, btn3].forEach(b => b.classList.remove('bg-ivory-accent', 'text-slate-900'));
            
            let text = "";
            if(val === 1) {
                btn1.classList.add('bg-ivory-accent', 'text-slate-900');
                text = "NT1: Combate T√°tico. Inimigos usam cobertura e focam em alvos isolados.";
            } else if (val === 2) {
                btn2.classList.add('bg-ivory-accent', 'text-slate-900');
                text = "NT2: Escala√ß√£o. O Boss ativa o 'Protocolo Exterm√≠nio' e ganha +2 de Ataque.";
            } else {
                btn3.classList.add('bg-ivory-accent', 'text-slate-900');
                text = "NT3: Zona de Guerra Total. Terreno dif√≠cil, explos√µes aleat√≥rias (4d6 fogo/rodada).";
            }
            desc.innerText = text;
            localStorage.setItem('aliados_tension', val);
        }

        function selectAction(type) {
            const actions = {
                'ATQ': 'COORDENAR FOGO: +2 Ataque. +4d6 Dano (Flanqueio).',
                'DEF': 'LINHA DE DEFESA: +5 Defesa. Cobertura Total.',
                'MOV': 'REPOSICIONAR: Deslocamento Dobrado. Foge de Combate.',
                'ESP': 'RITUAL DE GUERRA: Recupera 1 Baixa ou Buff em √Årea.'
            };
            alert(`Ordem T√°tica Selecionada!\n\n${actions[type]}\n\nAplique os b√¥nus descritos no turno do esquadr√£o.`);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadSquads();
            checkUrlSync();
            
            // Carregar configura√ß√£o de sincroniza√ß√£o
            syncSessionId = localStorage.getItem('sync_session_id');
            syncEndpoint = localStorage.getItem('sync_endpoint') || null;
            
            // Se j√° estava sincronizando, reativar
            if (syncSessionId && localStorage.getItem('sync_enabled') === 'true') {
                syncEnabled = true;
                toggleAutoSync();
            }
            
            const savedTension = localStorage.getItem('aliados_tension') || '1';
            setTension(parseInt(savedTension));
            renderSquads();
            renderStatusSummary();
            updateLastSyncTime();
        });

        // Salvar estado de sincroniza√ß√£o
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('sync_enabled', syncEnabled ? 'true' : 'false');
        });

    </script>
</body>
</html>

